{% extends '@SyliusShop/layout.html.twig' %}

{% form_theme form '@SyliusShop/Form/theme.html.twig' %}

{% import '@SyliusUi/Macro/messages.html.twig' as messages %}

{% set header = 'sylius.ui.your_shopping_cart' %}
{% set client_id = get_pay_pal_client_id(sylius.channel) %}

{% block title %}{{ parent() }} | {{ header|trans }}{% endblock %}

{% block content %}
    {% if not cart.empty %}
        {{ sylius_template_event('sylius.shop.cart.header', {'header': header, 'cart': cart}) }}
        <div class="ui stackable grid">
            <div class="eleven wide column">
                {{ sylius_template_event('sylius.shop.cart.items', {'cart': cart, 'form': form}) }}
            </div>
            <div class="five wide column">
                {{ sylius_template_event('sylius.shop.cart.summary', {'cart': cart}) }}

                <div id="paypal-button-container"></div>
            </div>
        </div>
        {{ sylius_template_event('sylius.shop.cart.suggestions', {'cart': cart}) }}
    {% else %}
        {{ messages.info('sylius.ui.your_cart_is_empty') }}
    {% endif %}
{% endblock %}

{% block javascripts %}
    {% if cart.payments|length > 0 and client_id %}
    <script src="https://www.paypal.com/sdk/js?client-id={{ client_id }}&disable-funding=credit,card,bancontact,blik,eps,giropay,ideal,mybank,p24,sepa,sofort,venmo" data-partner-attribution-id="{{ cart.payments.first().method.gatewayConfig.config['partner_attribution_id'] }}"></script>
    <script>
        let completeUrl = "{{ path('sylius_shop_checkout_complete') }}";
        let createPayPalOrderFromCartUrl = "{{ path('sylius_paypal_plugin_create_paypal_order_from_cart', {'id': cart.id}) }}";
        let processPayPalOrderUrl = "{{ path('sylius_paypal_plugin_process_paypal_order') }}";
        let orderId = "{{ cart.id }}";

        paypal.Buttons({
            createOrder: function(data, actions) {
                return fetch(createPayPalOrderFromCartUrl, {
                    method: 'post'
                }).then(res => res.json()).then(data => data.orderID);
            },

            onApprove: function(data, actions) {
                return fetch(processPayPalOrderUrl, {
                    method: 'post',
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({ payPalOrderId: data.orderID, orderId: orderId })
                })
                .then(res => res.json())
                .then(function(details) {
                    window.location.href = completeUrl;
                });
            }
        }).render('#paypal-button-container');
    </script>
    {% endif %}
{% endblock %}
